<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rippled: Deterministic Database Shards</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">rippled
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Deterministic Database Shards </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This doc describes the standard way to assemble the database shard. A shard assembled using this approach becomes deterministic i.e. if two independent sides assemble a shard consisting of the same ledgers, accounts and transactions, then they will obtain the same shard files <code>nudb.dat</code> and <code>nudb.key</code>. The approach deals with the <code>NuDB</code> database format only, refer to <code><a href="https://github.com/vinniefalco/NuDB">https://github.com/vinniefalco/NuDB</a></code>.</p>
<h1><a class="anchor" id="autotoc_md172"></a>
Headers</h1>
<p>Due to NuDB database definition, the following headers are used for database files:</p>
<p>nudb.key: </p><div class="fragment"><div class="line">char[8]         Type            The characters &quot;nudb.key&quot;</div>
<div class="line">uint16          Version         Holds the version number</div>
<div class="line">uint64          UID             Unique ID generated on creation</div>
<div class="line">uint64          Appnum          Application defined constant</div>
<div class="line">uint16          KeySize         Key size in bytes</div>
<div class="line">uint64          Salt            A random seed</div>
<div class="line">uint64          Pepper          The salt hashed</div>
<div class="line">uint16          BlockSize       Size of a file block in bytes</div>
<div class="line">uint16          LoadFactor      Target fraction in 65536ths</div>
<div class="line">uint8[56]       Reserved        Zeroes</div>
<div class="line">uint8[]         Reserved        Zero-pad to block size</div>
</div><!-- fragment --><p>nudb.dat: </p><div class="fragment"><div class="line">char[8]         Type            The characters &quot;nudb.dat&quot;</div>
<div class="line">uint16          Version         Holds the version number</div>
<div class="line">uint64          UID             Unique ID generated on creation</div>
<div class="line">uint64          Appnum          Application defined constant</div>
<div class="line">uint16          KeySize         Key size in bytes</div>
<div class="line">uint8[64]       (reserved)      Zeroes</div>
</div><!-- fragment --><p>All of these fields are saved using network byte order (bigendian: most significant byte first).</p>
<p>To make the shard deterministic the following parameters are used as values of header field both for <code>nudb.key</code> and <code>nudb.dat</code> files. </p><div class="fragment"><div class="line">Version         2</div>
<div class="line">UID             digest(0)</div>
<div class="line">Appnum          digest(2) | 0x5348524400000000 /* &#39;SHRD&#39; */</div>
<div class="line">KeySize         32</div>
<div class="line">Salt            digest(1)</div>
<div class="line">Pepper          XXH64(Salt)</div>
<div class="line">BlockSize       0x1000 (4096 bytes)</div>
<div class="line">LoadFactor      0.5 (numeric 0x8000)</div>
</div><!-- fragment --><p>Note: XXH64() is well-known hash algorithm.</p>
<p>The <code>digest(i)</code> mentioned above defined as the follows:</p>
<p>First, RIPEMD160 hash <code>H</code> calculated of the following structure (the same as final Key of the shard): </p><div class="fragment"><div class="line">uint32          version         Version of shard, 2 at the present</div>
<div class="line">uint32          firstSeq        Sequence number of first ledger in the shard</div>
<div class="line">uint32          lastSeq         Sequence number of last ledger in the shard</div>
<div class="line">uint256         lastHash        Hash of last ledger in shard</div>
</div><!-- fragment --><p>there all 32-bit integers are hashed in network byte order (bigendian: most significant byte first).</p>
<p>Then, <code>digest(i)</code> is defined as the following part of the above hash <code>H</code>: </p><div class="fragment"><div class="line">digest(0) = H[0] &lt;&lt; 56 | H[1] &lt;&lt; 48 | ... | H[7] &lt;&lt; 0,</div>
<div class="line">digest(1) = H[8] &lt;&lt; 56 | H[9] &lt;&lt; 48 | ... | H[15] &lt;&lt; 0,</div>
<div class="line">digest(2) = H[16] &lt;&lt; 24 | H[17] &lt;&lt; 16 | ... | H[19] &lt;&lt; 0,</div>
</div><!-- fragment --><p>where <code>H[i]</code> denotes <code>i</code>-th byte of hash <code>H</code>.</p>
<h1><a class="anchor" id="autotoc_md173"></a>
Contents</h1>
<p>After deterministic shard is created using the above mentioned headers, it filled with objects using the following steps.</p>
<ol type="1">
<li>All objects within the shard are visited in the order described in the next section. Here the objects are: ledger headers, SHAmap tree nodes including state and transaction nodes, final key.</li>
<li>Set of all visited objects is divided into groups. Each group except of the last contains 16384 objects in the order of their visiting. Last group may contain less than 16384 objects.</li>
<li>All objects within each group are sorted in according to their hashes. Objects are sorted by increasing of their hashes, precisely, by increasing of hex representations of hashes in lexicographic order. For example, the following is an example of sorted hashes in their hex representation: <div class="fragment"><div class="line">0000000000000000000000000000000000000000000000000000000000000000</div>
<div class="line">154F29A919B30F50443A241C466691B046677C923EE7905AB97A4DBE8A5C2429</div>
<div class="line">2231553FC01D37A66C61BBEEACBB8C460994493E5659D118E19A8DDBB1444273</div>
<div class="line">272DCBFD8E4D5D786CF11A5444B30FB35435933B5DE6C660AA46E68CF0F5C441</div>
<div class="line">3C062FD9F0BCDCA31ACEBCD8E530D0BDAD1F1D1257B89C435616506A3EE6CB9E</div>
<div class="line">58A0E5AE427CDDC1C7C06448E8C3E4BF718DE036D827881624B20465C3E1336F</div>
<div class="line">...</div>
</div><!-- fragment --></li>
<li>Finally, objects added to the deterministic shard group by group in the sorted order within each group from low to high hashes.</li>
</ol>
<h1><a class="anchor" id="autotoc_md174"></a>
Order of visiting objects</h1>
<p>The shard consists of 16384 ledgers and the final key with the hash 0. Each ledger has the header object and two SMAmaps: state and transaction. SHAmap is a rooted tree in which each node has maximum of 16 descendants enumerating by indexes 0..15. Visiting each node in the SHAmap is performing by functions visitNodes and visitDifferences implemented in the file <code>ripple/shamap/impl/ShaMapSync.cpp</code>.</p>
<p>Here is how the function visitNodes works: it visit the root at first. Then it visit all nodes in the 1st layer, i. e. the nodes which are immediately descendants of the root sequentially from index 0 to 15. Then it visit all nodes in 2nd layer i.e. the nodes which are immediately descendants the nodes from 1st layer. The order of visiting 2nd layer nodes is the following. First, descendants of the 1st layer node with index 0 are visited sequintially from index 0 to 15. Then descendents of 1st layer node with index 1 are visited etc. After visiting all nodes of 2nd layer the nodes from 3rd layer are visited etc.</p>
<p>The function visitDifferences works similar to visitNodes with the following exceptions. The first exception is that visitDifferences get 2 arguments: current SHAmap and previous SHAmap and visit only the nodes from current SHAmap which and not present in previous SHAmap. The second exception is that visitDifferences visits all non-leaf nodes in the order of visitNodes function, but all leaf nodes are visited immedeately after visiting of their parent node sequentially from index 0 to 15.</p>
<p>Finally, all objects within the shard are visited in the following order. All ledgers are visited from the ledger with high index to the ledger with low index in descending order. For each ledger the state SHAmap is visited first using visitNode function for the ledger with highest index and visitDifferences function for other ledgers. Then transaction SHAmap is visited using visitNodes function. At last, the ledger header object is visited. Final key of the shard is visited at the end.</p>
<h1><a class="anchor" id="autotoc_md175"></a>
Tests</h1>
<p>To perform test to deterministic shards implementation one can enter the following command: </p><div class="fragment"><div class="line">rippled --unittest ripple.NodeStore.DatabaseShard</div>
</div><!-- fragment --><p>The following is the right output of deterministic shards test: </p><div class="fragment"><div class="line">ripple.NodeStore.DatabaseShard DatabaseShard deterministic_shard</div>
<div class="line">with backend nudb</div>
<div class="line">Iteration 0: RIPEMD160[nudb.key] = F96BF2722AB2EE009FFAE4A36AAFC4F220E21951</div>
<div class="line">Iteration 0: RIPEMD160[nudb.dat] = FAE6AE84C15968B0419FDFC014931EA12A396C71</div>
<div class="line">Iteration 1: RIPEMD160[nudb.key] = F96BF2722AB2EE009FFAE4A36AAFC4F220E21951</div>
<div class="line">Iteration 1: RIPEMD160[nudb.dat] = FAE6AE84C15968B0419FDFC014931EA12A396C71</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
