<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rippled: Relational Database Interface</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">rippled
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Relational Database Interface </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Here are main principles of Relational DB interface:</p>
<p>1) All SQL hard code is in the files described below in Files section. No hard-coded SQL should be added to any other file in rippled, except related to tests for specific SQL implementations. 2) Pure interface class <code>RelationalDBInterface</code> can have several implementations for different relational database types. 3) For future use, if the node database is absent, then shard databases will be used.</p>
<h1><a class="anchor" id="autotoc_md129"></a>
Configuration</h1>
<p>Section <code>[relational_db]</code> of the configuration file contains parameter <code>backend</code>. The value of this parameter is the name of relational database implementation used for node or shard databases. At the present, the only valid value of this parameter is <code>sqlite</code>.</p>
<h1><a class="anchor" id="autotoc_md130"></a>
Files</h1>
<p>The following source files are related to Relational DB interface:</p>
<ul>
<li><code><a class="el" href="RelationalDBInterface_8h_source.html">ripple/app/rdb/RelationalDBInterface.h</a></code> - definition of main pure class of the interface, <code>RelationalDBInterface</code>;</li>
<li><code><a class="el" href="RelationalDBInterface_8cpp_source.html">ripple/app/rdb/impl/RelationalDBInterface.cpp</a></code> - implementation of static method <code>init()</code> of the class <code>RelationalDBInterface</code>;</li>
<li><code><a class="el" href="RelationalDBInterfaceSqlite_8h_source.html">ripple/app/rdb/backend/RelationalDBInterfaceSqlite.h</a></code> - definition of pure class <code>RelationalDBInterfaceSqlite</code> derived from <code>RelationalDBInterface</code>; this is base class for sqlite implementation of the interface;</li>
<li><code><a class="el" href="RelationalDBInterfaceSqlite_8cpp_source.html">ripple/app/rdb/backend/RelationalDBInterfaceSqlite.cpp</a></code> - implementation of <code>RelationalDBInterfaceSqlite</code>-derived class for the case of sqlite databases;</li>
<li><code><a class="el" href="RelationalDBInterfacePostgres_8h_source.html">ripple/app/rdb/backend/RelationalDBInterfacePostgres.h</a></code> - definition of pure class <code>RelationalDBInterfacePostgres</code> derived from <code>RelationalDBInterface</code>; this is base class for postgres implementation of the interface;</li>
<li><code><a class="el" href="RelationalDBInterfacePostgres_8cpp_source.html">ripple/app/rdb/backend/RelationalDBInterfacePostgres.cpp</a></code> - implementation of <code>RelationalDBInterfacePostgres</code>-derived class for the case of postgres databases;</li>
<li><code><a class="el" href="RelationalDBInterface__global_8h_source.html">ripple/app/rdb/RelationalDBInterface_global.h</a></code> - definitions of global methods for all sqlite databases except of node and shard;</li>
<li><code><a class="el" href="RelationalDBInterface__global_8cpp_source.html">ripple/app/rdb/impl/RelationalDBInterface_global.cpp</a></code> - implementations of global methods for all sqlite databases except of node and shard;</li>
<li><code><a class="el" href="RelationalDBInterface__nodes_8h_source.html">ripple/app/rdb/RelationalDBInterface_nodes.h</a></code> - definitions of global methods for sqlite node databases;</li>
<li><code><a class="el" href="RelationalDBInterface__nodes_8cpp_source.html">ripple/app/rdb/impl/RelationalDBInterface_nodes.cpp</a></code> - implementations of global methods for sqlite node databases;</li>
<li><code><a class="el" href="RelationalDBInterface__shards_8h_source.html">ripple/app/rdb/RelationalDBInterface_shards.h</a></code> - definitions of global methods for sqlite shard databases;</li>
<li><code><a class="el" href="RelationalDBInterface__shards_8cpp_source.html">ripple/app/rdb/impl/RelationalDBInterface_shards.cpp</a></code> - implementations of global methods for sqlite shard databases;</li>
<li><code><a class="el" href="RelationalDBInterface__postgres_8h_source.html">ripple/app/rdb/RelationalDBInterface_postgres.h</a></code> - definitions of internal methods for postgres databases;</li>
<li><code><a class="el" href="RelationalDBInterface__postgres_8cpp_source.html">ripple/app/rdb/impl/RelationalDBInterface_postgres.cpp</a></code> - implementations of internal methods for postgres databases;</li>
</ul>
<h1><a class="anchor" id="autotoc_md131"></a>
Classes</h1>
<p>The main class of the interface is <code>class RelationalDBInterface</code>. It is defined in the file <code><a class="el" href="RelationalDBInterface_8h_source.html">RelationalDBInterface.h</a></code>. This class has static method <code>init()</code> which allow to create proper <code>RelationalDBInterface</code>-derived class specified in the config. All other methods are pure virtual. These methods do not use database as a parameter. It assumed that implementation of class derived from <code>RelationalDBInterface</code> holds all database pointers inside and uses appropriate databases (nodes or shards) to get return values required by each method.</p>
<p>At the present, there are two implementations of the derived classes - <code>class RelationalDBInterfaceSqlite</code> for sqlite database (it is located in the file <code><a class="el" href="RelationalDBInterfaceSqlite_8cpp_source.html">RelationalDBInterfaceSqlite.cpp</a></code>) and <code>class RelationalDBInterfacePostgres</code> for postgres database (it is located in the file <code><a class="el" href="RelationalDBInterfacePostgres_8cpp_source.html">RelationalDBInterfacePostgres.cpp</a></code>)</p>
<h1><a class="anchor" id="autotoc_md132"></a>
Methods</h1>
<p>There are 3 types of methods for SQL interface:</p>
<p>1) Global methods for work with all databases except of node. In particular, methods related to shards datavases only. These methods are sqlite-specific. They use <code>soci::session</code> as database pointer parameter. Defined and implemented in files <code>RelationalDBInterface_global.*</code> and <code>RelationalDBInterface_shard.*</code>.</p>
<p>2) Global methods for work with node databases, and also with shard databases. For sqlite case, these methods are internal for <code>RelationalDBInterfaceSqlite</code> implementation of the class <code>RelationalDBInterface</code>. They use <code>soci::session</code> as database pointer parameter. Defined and implemented in files <code>RelationalDBInterface_nodes.*</code>. For postgres case, these methods are internal for <code>RelationalDBInterfacePostgres</code> implementation of the class <code>RelationalDBInterface</code>. They use <code><a class="elRef" href="http://en.cppreference.com/w/cpp/memory/shared_ptr.html" title="STL class.">std::shared_ptr</a>&lt;PgPool&gt;</code> as database pointer parameter. Defined and implemented in files <code>RelationalDBInterface_postgres.*</code>.</p>
<p>3) Virtual methods of class <code>RelationalDBInterface</code> and also derived classes <code>RelationalDBInterfaceSqlite</code> and <code>RelationalDBInterfacePostgres</code>. Calling such a method resulted in calling corresponding method from <code>RelationalDBInterface</code>-derived class. For sqlite case, such a method tries to retrieve information from node database, and if this database not exists - then from shard databases. For both node and shard databases, calls to global methods of type 2) performed. For postgres case, such a method retrieves information only from node database by calling a global method of type 2).</p>
<h1><a class="anchor" id="autotoc_md133"></a>
Methods lists</h1>
<h2><a class="anchor" id="autotoc_md134"></a>
Type 1 methods</h2>
<h3><a class="anchor" id="autotoc_md135"></a>
Files RelationalDBInterface_global.*</h3>
<p>Wallet DB methods: </p><div class="fragment"><div class="line">makeWalletDB</div>
<div class="line">makeTestWalletDB</div>
<div class="line">getManifests</div>
<div class="line">saveManifests</div>
<div class="line">addValidatorManifest</div>
<div class="line">getNodeIdentity</div>
<div class="line">getPeerReservationTable</div>
<div class="line">insertPeerReservation</div>
<div class="line">deletePeerReservation</div>
<div class="line">createFeatureVotes</div>
<div class="line">readAmendments</div>
<div class="line">voteAmendment</div>
</div><!-- fragment --><p>State DB methods: </p><div class="fragment"><div class="line">initStateDB</div>
<div class="line">getCanDelete</div>
<div class="line">setCanDelete</div>
<div class="line">getSavedState</div>
<div class="line">setSavedState</div>
<div class="line">setLastRotated</div>
</div><!-- fragment --><p>DatabaseBody DB methods: </p><div class="fragment"><div class="line">openDatabaseBodyDb</div>
<div class="line">databaseBodyDoPut</div>
<div class="line">databaseBodyFinish</div>
</div><!-- fragment --><p>Vacuum DB method: </p><div class="fragment"><div class="line">doVacuumDB</div>
</div><!-- fragment --><p>PeerFinder DB methods: </p><div class="fragment"><div class="line">initPeerFinderDB</div>
<div class="line">updatePeerFinderDB</div>
<div class="line">readPeerFinderDB</div>
<div class="line">savePeerFinderDB</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md136"></a>
Files RelationalDBInterface_shards.*</h3>
<p>Shards DB methods: </p><div class="fragment"><div class="line">makeShardCompleteLedgerDBs</div>
<div class="line">makeShardIncompleteLedgerDBs</div>
<div class="line">updateLedgerDBs</div>
</div><!-- fragment --><p>Shard acquire DB methods: </p><div class="fragment"><div class="line">makeAcquireDB</div>
<div class="line">insertAcquireDBIndex</div>
<div class="line">selectAcquireDBLedgerSeqs</div>
<div class="line">selectAcquireDBLedgerSeqsHash</div>
<div class="line">updateAcquireDB</div>
</div><!-- fragment --><p>Shard archive DB methods: </p><div class="fragment"><div class="line">makeArchiveDB</div>
<div class="line">readArchiveDB</div>
<div class="line">insertArchiveDB</div>
<div class="line">deleteFromArchiveDB</div>
<div class="line">dropArchiveDB</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md137"></a>
Type 2 methods</h2>
<h3><a class="anchor" id="autotoc_md138"></a>
Files RelationalDBInterface_nodes.*</h3>
<div class="fragment"><div class="line">makeLedgerDBs</div>
<div class="line">getMinLedgerSeq</div>
<div class="line">getMaxLedgerSeq</div>
<div class="line">deleteByLedgerSeq</div>
<div class="line">deleteBeforeLedgerSeq</div>
<div class="line">getRows</div>
<div class="line">getRowsMinMax</div>
<div class="line">saveValidatedLedger</div>
<div class="line">getLedgerInfoByIndex</div>
<div class="line">getOldestLedgerInfo</div>
<div class="line">getNewestLedgerInfo</div>
<div class="line">getLimitedOldestLedgerInfo</div>
<div class="line">getLimitedNewestLedgerInfo</div>
<div class="line">getLedgerInfoByHash</div>
<div class="line">getHashByIndex</div>
<div class="line">getHashesByIndex</div>
<div class="line">getHashesByIndex</div>
<div class="line">getTxHistory</div>
<div class="line">getOldestAccountTxs</div>
<div class="line">getNewestAccountTxs</div>
<div class="line">getOldestAccountTxsB</div>
<div class="line">getNewestAccountTxsB</div>
<div class="line">oldestAccountTxPage</div>
<div class="line">newestAccountTxPage</div>
<div class="line">getTransaction</div>
<div class="line">DbHasSpace</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md139"></a>
Files RelationalDBInterface_postgres.*</h3>
<div class="fragment"><div class="line">getMinLedgerSeq</div>
<div class="line">getMaxLedgerSeq</div>
<div class="line">getCompleteLedgers</div>
<div class="line">getValidatedLedgerAge</div>
<div class="line">getNewestLedgerInfo</div>
<div class="line">getLedgerInfoByIndex</div>
<div class="line">getLedgerInfoByHash</div>
<div class="line">getHashByIndex</div>
<div class="line">getHashesByIndex</div>
<div class="line">getTxHashes</div>
<div class="line">getAccountTx</div>
<div class="line">locateTransaction</div>
<div class="line">writeLedgerAndTransactions</div>
<div class="line">getTxHistory</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md140"></a>
Type 3 methods</h2>
<h3><a class="anchor" id="autotoc_md141"></a>
Files RelationalDBInterface.*</h3>
<div class="fragment"><div class="line">init</div>
<div class="line">getMinLedgerSeq</div>
<div class="line">getMaxLedgerSeq</div>
<div class="line">getLedgerInfoByIndex</div>
<div class="line">getNewestLedgerInfo</div>
<div class="line">getLedgerInfoByHash</div>
<div class="line">getHashByIndex</div>
<div class="line">getHashesByIndex</div>
<div class="line">getTxHistory</div>
<div class="line">ledgerDbHasSpace</div>
<div class="line">transactionDbHasSpace</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md142"></a>
Files backend/RelationalDBInterfaceSqlite.*</h3>
<div class="fragment"><div class="line">getTransactionsMinLedgerSeq</div>
<div class="line">getAccountTransactionsMinLedgerSeq</div>
<div class="line">deleteTransactionByLedgerSeq</div>
<div class="line">deleteBeforeLedgerSeq</div>
<div class="line">deleteTransactionsBeforeLedgerSeq</div>
<div class="line">deleteAccountTransactionsBeforeLedgerSeq</div>
<div class="line">getTransactionCount</div>
<div class="line">getAccountTransactionCount</div>
<div class="line">getLedgerCountMinMax</div>
<div class="line">saveValidatedLedger</div>
<div class="line">getLimitedOldestLedgerInfo</div>
<div class="line">getLimitedNewestLedgerInfo</div>
<div class="line">getOldestAccountTxs</div>
<div class="line">getNewestAccountTxs</div>
<div class="line">getOldestAccountTxsB</div>
<div class="line">getNewestAccountTxsB</div>
<div class="line">oldestAccountTxPage</div>
<div class="line">newestAccountTxPage</div>
<div class="line">oldestAccountTxPageB</div>
<div class="line">newestAccountTxPageB</div>
<div class="line">getTransaction</div>
<div class="line">getKBUsedAll</div>
<div class="line">getKBUsedLedger</div>
<div class="line">getKBUsedTransaction</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md143"></a>
Files backend/RelationalDBInterfacePostgres.*</h3>
<div class="fragment"><div class="line">sweep</div>
<div class="line">getCompleteLedgers</div>
<div class="line">getValidatedLedgerAge</div>
<div class="line">writeLedgerAndTransactions</div>
<div class="line">getTxHashes</div>
<div class="line">getAccountTx</div>
<div class="line">locateTransaction</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
